<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, user-scalable=no">
<title>Map Editor</title>
<link rel="stylesheet" class="theme" id="stylesheet-dark" href="dark.css">
<style>
html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
}
</style>
<script src="svg.js"></script>
<script>

const hexOffsetsY = [
  Math.cos(0/6 * Math.PI * 2),
  Math.cos(1/6 * Math.PI * 2),
  Math.cos(2/6 * Math.PI * 2),
  Math.cos(3/6 * Math.PI * 2),
  Math.cos(4/6 * Math.PI * 2),
  Math.cos(5/6 * Math.PI * 2),
];

const hexOffsetsX = [
  Math.sin(0/6 * Math.PI * 2),
  Math.sin(1/6 * Math.PI * 2),
  Math.sin(2/6 * Math.PI * 2),
  Math.sin(3/6 * Math.PI * 2),
  Math.sin(4/6 * Math.PI * 2),
  Math.sin(5/6 * Math.PI * 2),
];

let hexMembership = {"41":"","42":"","43":"","44":"","45":"","46":"","47":"","48":"","49":"","50":"","51":"","52":"","53":"","54":"","55":"","56":"","57":"","58":"","59":"","60":"","61":"","62":"","63":"","64":"","65":"","66":"","67":"","68":"","69":"","70":"","71":"","72":"","73":"","74":"","75":"","76":"","77":"","78":"","79":"","81":"","82":"","83":"","84":"","85":"","86":"","87":"","88":"","89":"","90":"na","91":"na","92":"na","93":"","94":"","95":"","96":"","97":"","98":"eu","99":"eu","100":"eu","101":"","102":"","103":"","104":"","105":"","106":"","107":"","108":"","109":"","110":"","111":"","112":"","113":"","114":"","115":"","116":"","117":"","118":"","119":"","121":"","122":"na","123":"na","124":"na","125":"na","126":"na","127":"","128":"","129":"","130":"na","131":"na","132":"na","133":"","134":"eu","135":"","136":"","137":"eu","138":"eu","139":"eu","140":"eu","141":"eu","142":"eu","143":"as","144":"as","145":"","146":"","147":"as","148":"as","149":"as","150":"as","151":"as","152":"as","153":"as","154":"","155":"","156":"","157":"","158":"","159":"","161":"","162":"na","163":"na","164":"na","165":"na","166":"na","167":"","168":"","169":"na","170":"","171":"na","172":"na","173":"na","174":"","175":"eu","176":"","177":"","178":"","179":"","180":"eu","181":"eu","182":"eu","183":"as","184":"as","185":"as","186":"as","187":"as","188":"as","189":"as","190":"as","191":"as","192":"as","193":"as","194":"","195":"","196":"","197":"","198":"","199":"","201":"","202":"","203":"na","204":"na","205":"na","206":"na","207":"na","208":"na","209":"na","210":"","211":"na","212":"na","213":"","214":"eu","215":"","216":"eu","217":"eu","218":"eu","219":"eu","220":"eu","221":"eu","222":"eu","223":"as","224":"as","225":"as","226":"as","227":"as","228":"as","229":"as","230":"as","231":"as","232":"as","233":"as","234":"","235":"","236":"","237":"","238":"","239":"","241":"","242":"","243":"","244":"na","245":"na","246":"na","247":"na","248":"na","249":"na","250":"","251":"","252":"na","253":"","254":"","255":"","256":"eu","257":"eu","258":"eu","259":"eu","260":"eu","261":"eu","262":"eu","263":"as","264":"as","265":"as","266":"as","267":"as","268":"as","269":"as","270":"as","271":"as","272":"as","273":"","274":"","275":"","276":"","277":"","278":"","279":"","281":"","282":"","283":"na","284":"na","285":"na","286":"na","287":"na","288":"na","289":"","290":"","291":"","292":"","293":"","294":"","295":"eu","296":"eu","297":"eu","298":"eu","299":"eu","300":"eu","301":"eu","302":"as","303":"as","304":"as","305":"as","306":"as","307":"as","308":"as","309":"as","310":"as","311":"as","312":"as","313":"","314":"as","315":"","316":"","317":"","318":"","319":"","321":"","322":"","323":"","324":"na","325":"na","326":"na","327":"na","328":"na","329":"","330":"","331":"","332":"","333":"","334":"eu","335":"eu","336":"eu","337":"eu","338":"eu","339":"eu","340":"eu","341":"eu","342":"as","343":"as","344":"as","345":"as","346":"as","347":"as","348":"as","349":"as","350":"as","351":"as","352":"as","353":"","354":"as","355":"","356":"","357":"","358":"","359":"","361":"","362":"","363":"","364":"na","365":"na","366":"","367":"","368":"na","369":"","370":"","371":"","372":"","373":"eu","374":"eu","375":"eu","376":"","377":"eu","378":"","379":"eu","380":"","381":"as","382":"as","383":"as","384":"","385":"","386":"as","387":"as","388":"as","389":"","390":"as","391":"as","392":"","393":"","394":"","395":"","396":"","397":"","398":"","399":"","401":"","402":"","403":"","404":"","405":"na","406":"na","407":"","408":"","409":"","410":"","411":"","412":"","413":"","414":"eu","415":"eu","416":"","417":"","418":"eu","419":"","420":"","421":"","422":"as","423":"as","424":"as","425":"","426":"","427":"as","428":"as","429":"","430":"","431":"as","432":"as","433":"","434":"","435":"","436":"","437":"","438":"","439":"","441":"","442":"","443":"","444":"","445":"","446":"na","447":"","448":"","449":"","450":"","451":"","452":"","453":"","454":"","455":"","456":"","457":"","458":"","459":"","460":"","461":"as","462":"as","463":"as","464":"as","465":"","466":"","467":"as","468":"","469":"","470":"","471":"as","472":"","473":"","474":"","475":"","476":"","477":"","478":"","479":"","481":"","482":"","483":"","484":"","485":"","486":"sa","487":"sa","488":"sa","489":"sa","490":"","491":"","492":"","493":"","494":"","495":"af","496":"af","497":"af","498":"af","499":"","500":"","501":"af","502":"","503":"as","504":"as","505":"","506":"","507":"","508":"","509":"","510":"","511":"","512":"","513":"","514":"","515":"","516":"","517":"","518":"","519":"","521":"","522":"","523":"","524":"","525":"sa","526":"sa","527":"sa","528":"sa","529":"sa","530":"","531":"","532":"","533":"","534":"af","535":"af","536":"af","537":"af","538":"af","539":"af","540":"af","541":"af","542":"","543":"as","544":"","545":"","546":"","547":"","548":"","549":"","550":"","551":"","552":"","553":"","554":"","555":"","556":"","557":"","558":"","559":"","561":"","562":"","563":"","564":"","565":"sa","566":"sa","567":"sa","568":"sa","569":"sa","570":"sa","571":"","572":"","573":"","574":"af","575":"af","576":"af","577":"af","578":"af","579":"af","580":"af","581":"af","582":"af","583":"af","584":"","585":"","586":"","587":"","588":"","589":"","590":"","591":"","592":"","593":"","594":"","595":"","596":"","597":"","598":"","599":"","601":"","602":"","603":"","604":"","605":"sa","606":"sa","607":"sa","608":"sa","609":"sa","610":"sa","611":"","612":"","613":"","614":"af","615":"af","616":"af","617":"af","618":"af","619":"af","620":"af","621":"af","622":"","623":"","624":"","625":"","626":"","627":"","628":"","629":"","630":"","631":"","632":"au","633":"au","634":"","635":"","636":"","637":"","638":"","639":"","641":"","642":"","643":"","644":"","645":"","646":"sa","647":"sa","648":"sa","649":"sa","650":"sa","651":"","652":"","653":"","654":"","655":"af","656":"af","657":"af","658":"af","659":"af","660":"af","661":"af","662":"","663":"","664":"","665":"","666":"","667":"","668":"","669":"","670":"","671":"au","672":"","673":"au","674":"","675":"au","676":"au","677":"","678":"","679":"","681":"","682":"","683":"","684":"","685":"","686":"sa","687":"sa","688":"sa","689":"sa","690":"","691":"","692":"","693":"","694":"","695":"","696":"","697":"af","698":"af","699":"af","700":"af","701":"","702":"","703":"","704":"","705":"","706":"","707":"","708":"","709":"","710":"","711":"au","712":"","713":"","714":"","715":"au","716":"au","717":"","718":"","719":"","721":"","722":"","723":"","724":"","725":"","726":"","727":"sa","728":"sa","729":"sa","730":"","731":"","732":"","733":"","734":"","735":"","736":"","737":"af","738":"af","739":"af","740":"af","741":"","742":"","743":"","744":"","745":"","746":"","747":"","748":"","749":"","750":"","751":"","752":"","753":"","754":"","755":"","756":"","757":"","758":"","759":"","761":"","762":"","763":"","764":"","765":"","766":"sa","767":"sa","768":"sa","769":"","770":"","771":"","772":"","773":"","774":"","775":"","776":"","777":"af","778":"af","779":"af","780":"af","781":"","782":"af","783":"","784":"","785":"","786":"","787":"","788":"","789":"","790":"","791":"","792":"au","793":"au","794":"","795":"au","796":"","797":"","798":"","799":"","801":"","802":"","803":"","804":"","805":"","806":"","807":"sa","808":"sa","809":"","810":"","811":"","812":"","813":"","814":"","815":"","816":"","817":"af","818":"af","819":"af","820":"af","821":"","822":"af","823":"","824":"","825":"","826":"","827":"","828":"","829":"","830":"","831":"","832":"au","833":"au","834":"au","835":"au","836":"au","837":"","838":"","839":"","841":"","842":"","843":"","844":"","845":"","846":"sa","847":"sa","848":"","849":"","850":"","851":"","852":"","853":"","854":"","855":"","856":"","857":"af","858":"af","859":"af","860":"","861":"","862":"","863":"","864":"","865":"","866":"","867":"","868":"","869":"","870":"","871":"au","872":"au","873":"au","874":"au","875":"au","876":"au","877":"","878":"","879":"","881":"","882":"","883":"","884":"","885":"","886":"","887":"sa","888":"","889":"","890":"","891":"","892":"","893":"","894":"","895":"","896":"","897":"","898":"af","899":"af","900":"","901":"","902":"","903":"","904":"","905":"","906":"","907":"","908":"","909":"","910":"","911":"","912":"au","913":"au","914":"au","915":"au","916":"au","917":"","918":"","919":"","921":"","922":"","923":"","924":"","925":"","926":"","927":"","928":"","929":"","930":"","931":"","932":"","933":"","934":"","935":"","936":"","937":"","938":"","939":"","940":"","941":"","942":"","943":"","944":"","945":"","946":"","947":"","948":"","949":"","950":"","951":"","952":"","953":"","954":"","955":"","956":"","957":"","958":"","959":""};

const kContinent2Color = {
  "": "black",
  "na": "#ff0",
  "sa": "#0ff",
  "eu": "#00f",
  "af": "#0f0",
  "as": "#f00",
  "au": "#f0f",
}

const kContinentAbbrs = [
  '', 'na', 'sa', 'eu', 'af', 'as', 'au'
  // '', 'as',
];

function coords2id(x, y) {
  return y * 40 + x;
}

function id2coords(i) {
  return [ i % 40, i / 40 | 0 ];
}

/*

To save the map paste this into console:

A = {}; for (let [k, v] of Array.from(document.getElementsByTagName('polygon')).map(x => [x.getAttribute('tileId'), x.getAttribute('continent')])) A[k] = v; JSON.stringify(A)

Copy the output and paste it into the "let hexMembership = " line above.  Then reload the page and paste this into console:

JSON.stringify(tiles, null, 1)

And copy-paste the output into "map.json"

*/

let tileAdjacencies = {};
let tiles = {};
window.addEventListener('load', () => {
  const s = 16;
  for (let y = 1; y < 24; ++y) {
    for (let x = 1; x < 40; ++x) {
      let id = coords2id(x, y);
      tileAdjacencies[id] = [];
      tileAdjacencies[id].push(coords2id(x + 1, y));
      tileAdjacencies[id].push(coords2id(x - 1, y));
      tileAdjacencies[id].push(coords2id(x, y + 1));
      tileAdjacencies[id].push(coords2id(x, y - 1));
      if (y % 2 === 0) {
        tileAdjacencies[id].push(coords2id(x - 1, y + 1));
        tileAdjacencies[id].push(coords2id(x - 1, y - 1));
      } else {
        tileAdjacencies[id].push(coords2id(x + 1, y + 1));
        tileAdjacencies[id].push(coords2id(x + 1, y - 1));
      }
      let hexagon = svg.polygon(
        hexOffsetsX.map(dx => (Math.sqrt(3) * (x + (y % 2) * 0.5) + dx) * s),
        hexOffsetsY.map(dy => (1.5 * y + dy) * s),
        {}
      );
      hexagon.style.stroke = '#888';
      hexagon.setAttribute('tileId', id);
      hexagon.setAttribute('tileY', y);
      hexagon.setAttribute('tileX', x);
      hexagon.addEventListener('click', (e) => {
        let i = kContinentAbbrs.indexOf(hexagon.getAttribute('continent'));
        hexagon.setAttribute('continent', kContinentAbbrs[(i + 1) % kContinentAbbrs.length]);
      });
      new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes') {
            let hexagon = mutation.target;
            let color = kContinent2Color[hexagon.getAttribute('continent')];
            hexagon.style.fill = color;
          }
        })
      }).observe(hexagon, {"attributes": true});
      hexagon.setAttribute('continent', hexMembership[hexagon.getAttribute('tileId')]);
      hexagon.style.fill = kContinent2Color[hexagon.getAttribute('continent')];
      hexMap.appendChild(hexagon);
    }
  }

  // Filter out ocean adjacencies
  let hexagons = Array.from(document.getElementsByTagName('polygon'));
  let ids = hexagons.map(x => parseInt(x.getAttribute('tileId')));
  let badTiles = {}
  for (let a in tileAdjacencies) {
    a = parseInt(a);
    if (!hexagons[ids.indexOf(a)].getAttribute('continent')) {
      badTiles[a] = null;
      continue;
    }
    let bad = [];
    for (let b of tileAdjacencies[a]) {
      if (!ids.includes(b)) {
        bad.push(b);
        badTiles[b] = null;
        continue;
      }
      let i = ids.indexOf(b);
      if (!hexagons[i].getAttribute('continent')) {
        badTiles[b] = null;
        bad.push(b);
      }
    }
    for (let b of bad) {
      tileAdjacencies[a].splice(tileAdjacencies[a].indexOf(b), 1);
    }
  }

  for (let a in badTiles) {
    delete tileAdjacencies[a];
  }

  for (let id in tileAdjacencies) {
    id = parseInt(id)
    let hexagon = hexagons[ids.indexOf(id)];
    let c = hexagon.getAttribute('continent');
    if (!c || !(c in kContinent2Color)) {
      continue;
    }
    tiles[id] = {
      "id": id,
      "adjacencies": tileAdjacencies[id],
      "x": id2coords(id)[0],
      "y": id2coords(id)[1],
      "homeContinent": c.toUpperCase(),
      "income": 1,
    }
  }
});
</script>
</head>
<body>

<div id='mapDiv' style="display: block; width: 100%; height: 100%; position:relative;">
<svg id="hexMap" style="position:absolute; left:0; top:0; width:100%; height:100%;" viewBox="0 0 1200 700"></svg>
</div>
</body>
</html>
